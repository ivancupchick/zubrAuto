!function(e){var t={};function i(r){if(t[r])return t[r].exports;var n=t[r]={i:r,l:!1,exports:{}};return e[r].call(n.exports,n,n.exports,i),n.l=!0,n.exports}i.m=e,i.c=t,i.d=function(e,t,r){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(i.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)i.d(r,n,function(t){return e[t]}.bind(null,n));return r},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=27)}([function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Models=void 0,function(e){e.CARS_TABLE_NAME="public.cars",e.CAR_OWNERS_TABLE_NAME="public.carOwners",e.CLIENTS_TABLE_NAME="public.clients",e.USERS_TABLE_NAME="public.users",e.USER_TOKENS_TABLE_NAME="public.userTokens",e.FILE_CHAINS_TABLE_NAME="public.filesIds",e.FILES_TABLE_NAME="public.files",e.FIELD_CHAINS_TABLE_NAME="public.fieldIds",e.FIELDS_TABLE_NAME="public.fields",e.ROLES_TABLE_NAME="public.roles",e.FIELD_ACCESSES_TABLE_NAME="public.fieldAccesses",e.CAR_FORMS_TABLE_NAME="public.carForms",e.CAR_STATISTIC_TABLE_NAME="public.carStatistic"}(t.Models||(t.Models={}))},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ApiError=void 0;class r extends Error{constructor(e,t,i=[]){super(t),this.status=e,this.errors=i}static UnauthorizedError(){return new r(401,"Пользователь не авторизован")}static BadRequest(e,t=[]){return new r(400,e,t)}}t.ApiError=r},function(e,t,i){"use strict";var r=this&&this.__awaiter||function(e,t,i,r){return new(i||(i=Promise))((function(n,a){function o(e){try{d(r.next(e))}catch(e){a(e)}}function s(e){try{d(r.throw(e))}catch(e){a(e)}}function d(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,s)}d((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.BaseRepository=void 0;const n=i(11),a=i(37),o=i(1);t.BaseRepository=class{constructor(e){this.tableName=e}query(e){return r(this,void 0,void 0,(function*(){return yield a.db.query(e)}))}create(e){return r(this,void 0,void 0,(function*(){const t=(0,n.getInsertOneQuery)(this.tableName,e);console.log(t);const i=yield this.query(t);return this.getOneRow(i)}))}updateById(e,t){return r(this,void 0,void 0,(function*(){const i=(0,n.getUpdateByIdQuery)(this.tableName,e,t);console.log(i);const r=yield this.query(i);return this.getOneRow(r)}))}update(e,t){return r(this,void 0,void 0,(function*(){const i=(0,n.getUpdateByAndExpressionQuery)(this.tableName,e,t);console.log(i);const r=yield this.query(i);return this.getOneRow(r)}))}deleteById(e){return r(this,void 0,void 0,(function*(){const t=(0,n.getDeleteByIdQuery)(this.tableName,e);console.log(t);const i=yield this.query(t);return this.getOneRow(i)}))}deleteOne(e){return r(this,void 0,void 0,(function*(){const t=(0,n.getDeleteByAndExpressions)(this.tableName,e);console.log(t);const i=yield this.query(t);return this.getOneRow(i)}))}find(e){return r(this,void 0,void 0,(function*(){const t=(0,n.getGetAllByExpressionAndQuery)(this.tableName,e);console.log(t);const i=yield this.query(t);return this.getAllRows(i)}))}findOne(e){return r(this,void 0,void 0,(function*(){const t=(0,n.getGetAllByExpressionAndQuery)(this.tableName,e);console.log(t);const i=yield this.query(t);return this.getOneRow(i)}))}findById(e){return r(this,void 0,void 0,(function*(){const t=(0,n.getGetByIdQuery)(this.tableName,e);console.log(t);const i=yield this.query(t);return this.getOneRow(i)}))}getAll(){return r(this,void 0,void 0,(function*(){const e=(0,n.getGetAllQuery)(this.tableName);console.log(e);const t=yield this.query(e);return this.getAllRows(t)}))}getAllRows(e){return e.rows||[]}getOneRow(e){if(e.rows.length>1)throw new o.ApiError(400,"Ошибка бд");return 0!==e.rows.length&&e.rows[0]?e.rows[0]:null}}},function(e,t){e.exports=require("express-validator")},function(e,t){e.exports=require("express")},function(e,t,i){"use strict";const r=i(0),n=i(2);class a extends n.BaseRepository{constructor(){super(r.Models.FIELD_CHAINS_TABLE_NAME)}}e.exports=new a},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CarFormEnums=t.FieldNames=void 0,function(e){let t,i,r,n,a,o;!function(e){e.date="date",e.source="source",e.name="name",e.number="number",e.email="email",e.paymentType="payment-type",e.tradeInAuto="trade-in-auto",e.dealStatus="deal-status",e.comment="comment"}(t=e.Client||(e.Client={})),function(e){e.status="status",e.engine="engine",e.engineCapacity="engine-capacity",e.mileage="mileage",e.year="year",e.mark="mark",e.model="model",e.transmission="transmission",e.color="color",e.driveType="drive-type",e.linkToAd="link-to-ad",e.carOwnerPrice="car-owner-price",e.commission="commission",e.comment="comment",e.dateOfLastStatusChange="date-of-last-status-change",e.dateOfLastCustomerCall="date-of-last-customer-call",e.worksheet="worksheet",e.bargain="bargain",e.adPrice="ad-price",e.shootingDate="shooting-date",e.shootingTime="shooting-time",e.ourLinks="our-links",e.contactCenterSpecialistId="contact-center-specialist-id",e.carShootingSpecialistId="car-shooting-specialist-id",e.source="source",e.statistic="statistic",e.bodyType="body-type",e.contactCenterSpecialist="contact-center-specialist",e.mainPhotoId="main-photo-id"}(i=e.Car||(e.Car={})),function(e){e.contactCenter_InProgress="[ОКЦ]В работе",e.contactCenter_NoAnswer="[ОКЦ]Недозвон",e.contactCenter_MakingDecision="[ОКЦ]Принимает решение",e.contactCenter_WaitingShooting="[ОКЦ]Ожидание съемки",e.contactCenter_Deny="[ОКЦ]Отказ",e.contactCenter_Refund="[ОКЦ]Возврат от ОСА",e.carShooting_InProgres="[ОСА]в работе",e.carShooting_Refund="[ОСА]Возврат от ОРК",e.carShooting_Ready="[ОСА]готов",e.customerService_InProgress="[ОРК]в работе",e.customerService_OnPause="[ОРК]на паузе",e.customerService_OnDelete="[ОРК]на удаление",e.customerService_Sold="[ОРК]продана",e.carSales_Deposit="[ОПА]Дан задаток",e.admin_Deleted="[Админ]Удалена"}(r=e.CarStatus||(e.CarStatus={})),function(e){e.InProgress="В работе",e.Deny="Отказ",e.Sold="Продано",e.OnDeposit="Дал задаток"}(n=e.DealStatus||(e.DealStatus={})),function(e){e.name="name",e.ownerNumber="ownerNumber"}(a=e.CarOwner||(e.CarOwner={})),function(e){e.name="name"}(o=e.User||(e.User={}))}(t.FieldNames||(t.FieldNames={})),function(e){let t,i,r,n,a;!function(e){e.country="country",e.firstSaleCountry="firstSaleCountry",e.ownerCounty="ownerCounty",e.lastSaleWhere="lastSaleWhere",e.lastSaleWhen="lastSaleWhen",e.lastSaleMileage="lastSaleMileage",e.bodyCondition="bodyCondition",e.interiorCondition="interiorCondition",e.oilLeak="oilLeak",e.oilLoss="oilLoss",e.suspensionCondition="suspensionCondition",e.repairCondition="repairCondition",e.activeErrors="activeErrors",e.inCarDoesntWork="inCarDoesntWork",e.whereWasServed="whereWasServed",e.serviceHistory="serviceHistory",e.serviceOrders="serviceOrders",e.dateOrMileageOfLastMaintenance="dateOrMileageOfLastMaintenance",e.repairOfLastMaintenance="repairOfLastMaintenance",e.carEquipment="carEquipment",e.officialEquipmentName="officialEquipmentName",e.oilChangeDate="oilChangeDate",e.engineChainChangeWhen="engineChainChangeWhen",e.WDMaintenanceDate="WDMaintenanceDate",e["fuelСonsumption"]="fuelСonsumption"}(t=e.CarQuestionnaire||(e.CarQuestionnaire={})),function(e){e.documentOwner="documentOwner",e.ownerGrade="ownerGrade",e.saleReason="saleReason",e.termSelling="termSelling",e.harrySelling="harrySelling",e.callFrequency="callFrequency",e.costProposals="costProposals",e.sumProposals="sumProposals",e.expectedSum="expectedSum",e.reasonExpectedSum="reasonExpectedSum",e.stateNumbers="stateNumbers",e.leasing="leasing",e.readyToSale="readyToSale",e.testDriveAvailable="testDriveAvailable",e.additionalContact="additionalContact"}(i=e.GeneralCondition||(e.GeneralCondition={})),function(e){e.date="date",e.name="name",e.number="number",e.vin="vin",e.brandModel="brandModel",e.capacity="capacity",e.color="color",e.power="power",e.seats="seats",e.fuel="fuel",e.year="year",e.transmission="transmission",e.mileage="mileage",e.guarantee="guarantee",e.termGuarantee="termGuarantee",e.driveType="driveType",e.stateInspection="stateInspection",e.termStateInspection="termStateInspection",e.valueAddedTax="valueAddedTax",e.engineCondition="engineCondition",e.interiorCondition="interiorCondition",e.exteriorCondition="exteriorCondition"}(r=e.Inspection||(e.Inspection={})),function(e){e.rightFrontFender="rightFrontFender",e.rightFrontDoor="rightFrontDoor",e.rightRearDoor="rightRearDoor",e.rightRearFender="rightRearFender",e.leftFrontFender="leftFrontFender",e.leftFrontDoor="leftFrontDoor",e.leftRearDoor="leftRearDoor",e.leftRearFender="leftRearFender",e.hood="hood",e.roof="roof",e.trunk="trunk"}(n=e.ExteriorInspection||(e.ExteriorInspection={})),function(e){e.serviceHistory="serviceHistory",e.guide="guide",e.halogen="halogen",e.xenon="xenon",e.steediodes="steediodes",e.LEDDRL="LEDDRL",e.fogLights="fogLights",e.heatedWindshield="heatedWindshield",e.heatedSteeringWheel="heatedSteeringWheel",e.heatedFrontSeats="heatedFrontSeats",e.heatedRearSeats="heatedRearSeats",e.lightSensor="lightSensor",e.rainSensor="rainSensor",e.tintedGlass="tintedGlass",e.luke="luke",e.panoramicView="panoramicView",e.airConditioning="airConditioning",e.climateControl="climateControl",e.monochromeDisplay="monochromeDisplay",e.colorDisplay="colorDisplay",e.rearSeatScreens="rearSeatScreens",e.textile="textile",e.combined="combined",e.leather="leather",e.multifunction="multifunction",e.frontParkingSensors="frontParkingSensors",e.rearParkingSensors="rearParkingSensors",e.blindSpotIndicator="blindSpotIndicator",e.frontViewCamera="frontViewCamera",e.rearViewCamera="rearViewCamera",e.camera360="camera360",e.headUpDisplay="headUpDisplay",e.laneDepartureIndicator="laneDepartureIndicator",e.carParkingSystem="carParkingSystem",e.cruiseControl="cruiseControl",e.adaptiveCruiseControl="adaptiveCruiseControl",e.automaticHighLowBeam="automaticHighLowBeam",e.electricallyAdjustableSeats="electricallyAdjustableSeats",e.seatMemory="seatMemory",e.seatVentilation="seatVentilation",e.powerMirrors="powerMirrors",e.electroFoldingMirrors="electroFoldingMirrors",e.trunkElectricDrive="trunkElectricDrive",e.doorPresses="doorPresses",e.leatherSteeringWheel="leatherSteeringWheel",e.signaling="signaling",e.airSuspension="airSuspension",e.premiumAcoustics="premiumAcoustics",e.towbar="towbar",e.startStopSystem="startStopSystem",e.engineStartButton="engineStartButton",e.keylessAccess="keylessAccess",e.roofRails="roofRails",e.trafficSignRecognition="trafficSignRecognition",e.numberOfKeys="numberOfKeys"}(a=e.Checkboxes||(e.Checkboxes={}))}(t.CarFormEnums||(t.CarFormEnums={}))},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getDomainByTableName=t.getTableNameByDomain=t.FieldType=t.FieldDomains=void 0;const r=i(0);var n;!function(e){e[e.Car=0]="Car",e[e.CarOwner=1]="CarOwner",e[e.Client=2]="Client",e[e.User=3]="User",e[e.Role=4]="Role"}(n=t.FieldDomains||(t.FieldDomains={})),function(e){e[e.Boolean=0]="Boolean",e[e.Radio=1]="Radio",e[e.Text=2]="Text",e[e.Multiselect=3]="Multiselect",e[e.Number=4]="Number",e[e.Dropdown=5]="Dropdown"}(t.FieldType||(t.FieldType={})),t.getTableNameByDomain=function(e){switch(e){case n.Role:return r.Models.ROLES_TABLE_NAME;default:return"None"}},t.getDomainByTableName=function(e){switch(e){case r.Models.ROLES_TABLE_NAME:return n.Role;default:return 1e3}}},function(e,t,i){"use strict";var r=this&&this.__awaiter||function(e,t,i,r){return new(i||(i=Promise))((function(n,a){function o(e){try{d(r.next(e))}catch(e){a(e)}}function s(e){try{d(r.throw(e))}catch(e){a(e)}}function d(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,s)}d((r=r.apply(e,t||[])).next())}))},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};const a=i(1),o=n(i(5));e.exports=new class{getAllFieldChains(){return r(this,void 0,void 0,(function*(){return yield o.default.getAll()}))}createFieldChain(e){return r(this,void 0,void 0,(function*(){if(yield o.default.findOne({sourceId:[""+e.sourceId],fieldId:[""+e.fieldId],sourceName:[""+e.sourceName]}))throw a.ApiError.BadRequest("This Field Chain exists");return yield o.default.create({fieldId:e.fieldId,value:e.value||"",sourceId:e.sourceId,sourceName:e.sourceName})}))}updateFieldChain(e,t){return r(this,void 0,void 0,(function*(){return yield o.default.updateById(e,t)}))}deleteFieldChain(e){return r(this,void 0,void 0,(function*(){return yield o.default.deleteById(e)}))}getFieldChain(e){return r(this,void 0,void 0,(function*(){return yield o.default.findById(e)}))}}},function(e,t,i){"use strict";var r=this&&this.__awaiter||function(e,t,i,r){return new(i||(i=Promise))((function(n,a){function o(e){try{d(r.next(e))}catch(e){a(e)}}function s(e){try{d(r.throw(e))}catch(e){a(e)}}function d(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,s)}d((r=r.apply(e,t||[])).next())}))},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};const a=i(0),o=i(7),s=i(1),d=n(i(12)),l=n(i(19)),u=n(i(14)),c=n(i(18)),f=n(i(20)),m=n(i(8)),p=n(i(5)),y=n(i(21));e.exports=new class{getAll(){return r(this,void 0,void 0,(function*(){const[e,t]=yield Promise.all([d.default.getAll(),y.default.getAll()]);return e.map(e=>Object.assign(Object.assign({},e),{accesses:t.filter(t=>t.fieldId===e.id).map(e=>({id:e.id,fieldId:e.fieldId,sourceId:e.sourceId,domain:(0,o.getDomainByTableName)(e.sourceName),access:e.access}))}))}))}create(e){return r(this,void 0,void 0,(function*(){if(yield d.default.findOne({name:[e.name],domain:[""+e.domain]}))throw s.ApiError.BadRequest(`Field ${e.name} exists`);const t=yield d.default.create({flags:e.flags||0,type:e.type||o.FieldType.Text,name:e.name.toLowerCase(),domain:e.domain,variants:e.variants,showUserLevel:e.showUserLevel});e.accesses&&(yield Promise.all((e.accesses||[]).map(e=>y.default.create({sourceId:e.sourceId,fieldId:t.id,access:e.access,sourceName:(0,o.getTableNameByDomain)(e.domain)}))));let i="",r=[];switch(t.domain){case o.FieldDomains.Car:i=a.Models.CARS_TABLE_NAME,r=yield l.default.getAll();break;case o.FieldDomains.User:i=a.Models.USERS_TABLE_NAME,r=yield u.default.getAll();break;case o.FieldDomains.CarOwner:i=a.Models.CAR_OWNERS_TABLE_NAME,r=yield c.default.getAll();break;case o.FieldDomains.Client:i=a.Models.CLIENTS_TABLE_NAME,r=yield f.default.getAll()}return yield Promise.all(r.map(e=>m.default.createFieldChain({sourceId:e.id,fieldId:t.id,value:"",sourceName:i}))),t}))}update(e,t){return r(this,void 0,void 0,(function*(){const i=[...t.accesses];delete t.accesses,t.name&&(t.name,t.name.trim());const r=yield d.default.updateById(e,t),n=i.length>0?yield y.default.find({fieldId:[""+e]}):[],a=i.filter(e=>!n.find(t=>t.sourceId===e.sourceId&&t.sourceName===(0,o.getTableNameByDomain)(e.domain)));return yield Promise.all(n.map(e=>{const t=i.find(t=>t.sourceId===e.sourceId&&(0,o.getTableNameByDomain)(t.domain)===e.sourceName),r=t?t.access:null;switch(r){case null:case 0:return y.default.deleteById(e.id)}return y.default.updateById(e.id,{access:r})}).filter(e=>e)),yield Promise.all(a.map(t=>y.default.create({sourceId:t.sourceId,fieldId:e,access:t.access,sourceName:(0,o.getTableNameByDomain)(t.domain)}))),r}))}delete(e){return r(this,void 0,void 0,(function*(){const t=yield d.default.findById(e);let i="",r=[];switch(t.domain){case o.FieldDomains.Car:i=a.Models.CARS_TABLE_NAME,r=yield l.default.getAll();break;case o.FieldDomains.User:i=a.Models.USERS_TABLE_NAME,r=yield u.default.getAll();break;case o.FieldDomains.CarOwner:i=a.Models.CAR_OWNERS_TABLE_NAME,r=yield c.default.getAll();break;case o.FieldDomains.Client:i=a.Models.CLIENTS_TABLE_NAME,r=yield f.default.getAll()}const n=(yield y.default.find({fieldId:[""+e]}))||[],s=yield p.default.find({sourceId:r.map(e=>""+e.id),fieldId:[""+t.id]});return yield Promise.all([...s.map(e=>p.default.deleteById(e.id))]),yield Promise.all([...n.map(e=>y.default.deleteById(e.id))]),yield d.default.deleteById(e),t}))}get(e){return r(this,void 0,void 0,(function*(){const[t,i]=yield Promise.all([d.default.findById(e),y.default.getAll()]);return Object.assign(Object.assign({},t),{accesses:i.filter(e=>e.fieldId===t.id).map(e=>({id:e.id,fieldId:e.fieldId,sourceId:e.sourceId,domain:(0,o.getDomainByTableName)(e.sourceName),access:e.access}))})}))}getFieldsByDomain(e){return r(this,void 0,void 0,(function*(){const[t,i]=yield Promise.all([d.default.find({domain:[""+e]}),y.default.getAll()]);return t.map(e=>Object.assign(Object.assign({},e),{accesses:i.filter(t=>t.fieldId===e.id).map(e=>({id:e.id,fieldId:e.fieldId,sourceId:e.sourceId,domain:(0,o.getDomainByTableName)(e.sourceName),access:e.access}))}))}))}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Constants=void 0,function(e){let t;!function(e){e.CARS="cars",e.USERS="users",e.CRUD="crud",e.STATISTIC="statistic",e.CLIENTS="clients",e.FIELDS="fields",e.ROLES="roles",e.GET_FIELDS_BY_DOMAIN="getFieldsByDomain",e.CREATE_CARS_BY_LINK="createCarsByLink",e.IMAGES="images",e.IMAGE360="image360",e.STATE_IMAGES="stateImages",e.ADD_CALL="addCall",e.ADD_CUSTOMER_CALL="addCustomerCall",e.ADD_CUSTOMER_DISCOUNT="addCustomerDiscount",e.CAR_SHOWING="carShowing",e.COMPLETE_DEAL="completeDeal"}(t=e.API||(e.API={}))}(t.Constants||(t.Constants={}))},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getGetAllByExpressionOrQuery=t.getGetAllByExpressionAndQuery=t.getGetAllByOneColumnExpressionQuery=t.getInsertOneQuery=t.getUpdateByAndExpressionQuery=t.getUpdateByIdQuery=t.getDeleteByAndExpressions=t.getDeleteByIdQuery=t.getGetByIdQuery=t.getGetAllQuery=void 0;t.getGetAllQuery=e=>`SELECT * FROM "${e}";`;t.getGetByIdQuery=(e,t)=>`SELECT * FROM "${e}" WHERE id = ${t};`;t.getDeleteByIdQuery=(e,i)=>(0,t.getDeleteByAndExpressions)(e,{id:[""+i]});t.getDeleteByAndExpressions=(e,t)=>`DELETE FROM "${e}" WHERE (${Object.keys(t).map(e=>`"${e}" IN (${t[e].map(e=>`'${e}'`).join(",")})`).join(" AND ")}) RETURNING *;`;t.getUpdateByIdQuery=(e,t,i,r=!1)=>{const n={};return Object.keys(i).filter(e=>r?"id"!==e&&"value"!==e:"id"!==e).forEach(e=>n[e]=""+i[e]),`UPDATE "${e}" SET ${Object.keys(n).map(e=>`"${e}" = '${n[e]}'`).join(",")} WHERE id = ${t} RETURNING *;`};t.getUpdateByAndExpressionQuery=(e,t,i,r=!1)=>{const n={};return Object.keys(t).filter(e=>r?"id"!==e&&"value"!==e:"id"!==e).forEach(e=>n[e]=""+t[e]),`UPDATE "${e}" SET ${Object.keys(n).map(e=>`"${e}" = '${n[e]}'`).join(",")} WHERE (${Object.keys(i).map(e=>`"${e}" IN (${i[e].map(e=>`'${e}'`).join(",")})`).join(" AND ")}) RETURNING *;`},t.getInsertOneQuery=function(e,t){const i={};Object.keys(t).filter(e=>"id"!==e).forEach(e=>i[e]=""+t[e]);const r=Object.keys(i).map(e=>`"${e}"`),n=Object.keys(i).map(e=>`'${i[e]}'`);return`INSERT INTO "${e}" (${r.join(",")}) VALUES(${n.join(",")}) RETURNING *;`};t.getGetAllByOneColumnExpressionQuery=(e,i)=>(0,t.getGetAllByExpressionAndQuery)(e,i);t.getGetAllByExpressionAndQuery=(e,t)=>`WITH data AS (SELECT * FROM "${e}" WHERE (${Object.keys(t).map(e=>`"${e}" IN (${t[e].map(e=>`'${e}'`).join(",")})`).join(" AND ")})) SELECT * FROM data;`;t.getGetAllByExpressionOrQuery=(e,t)=>`WITH data AS (SELECT * FROM "${e}" WHERE (${Object.keys(t).map(e=>`"${e}" IN (${t[e].map(e=>`'${e}'`).join(",")})`).join(" OR ")})) SELECT * FROM data;`},function(e,t,i){"use strict";var r=this&&this.__awaiter||function(e,t,i,r){return new(i||(i=Promise))((function(n,a){function o(e){try{d(r.next(e))}catch(e){a(e)}}function s(e){try{d(r.throw(e))}catch(e){a(e)}}function d(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,s)}d((r=r.apply(e,t||[])).next())}))};const n=i(0),a=i(11),o=i(2);class s extends o.BaseRepository{constructor(){super(n.Models.FIELDS_TABLE_NAME)}updateById(e,t){return r(this,void 0,void 0,(function*(){const i=(0,a.getUpdateByIdQuery)(this.tableName,e,t,!0);console.log(i);const r=yield this.query(i);return this.getOneRow(r)}))}update(e,t){return r(this,void 0,void 0,(function*(){const i=(0,a.getUpdateByAndExpressionQuery)(this.tableName,e,t,!0);console.log(i);const r=yield this.query(i);return this.getOneRow(r)}))}}e.exports=new s},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getFieldsWithValues=t.FlagField=void 0;const r=i(47);!function(e){let t;!function(e){e[e.System=1]="System",e[e.Virtual=2]="Virtual"}(t=e.Flags||(e.Flags={})),e.setFlagOn=function(e,t){e.flags=r.BitHelper.setOn(e.flags,t)},e.setFlagOff=function(e,t){e.flags=r.BitHelper.setOff(e.flags,t)},e.Is=function(e,t){const i="number"==typeof e?e:e.flags;return r.BitHelper.Is(i,t)}}(t.FlagField||(t.FlagField={}));t.getFieldsWithValues=(e,t,i)=>e.filter(e=>!!t.filter(e=>e.sourceId===i).find(t=>t.fieldId===e.id)).map(e=>{var r;return{id:e.id,name:e.name,flags:e.flags,type:e.type,domain:e.domain,variants:e.variants,showUserLevel:e.showUserLevel,value:(null===(r=t.find(t=>t.fieldId===e.id&&t.sourceId===i))||void 0===r?void 0:r.value)||""}})},function(e,t,i){"use strict";const r=i(0),n=i(2);class a extends n.BaseRepository{constructor(){super(r.Models.USERS_TABLE_NAME)}}e.exports=new a},function(e,t,i){"use strict";const r=i(0),n=i(2);class a extends n.BaseRepository{constructor(){super(r.Models.ROLES_TABLE_NAME)}}e.exports=new a},function(e,t){e.exports=require("dotenv")},function(e,t,i){"use strict";var r=this&&this.__awaiter||function(e,t,i,r){return new(i||(i=Promise))((function(n,a){function o(e){try{d(r.next(e))}catch(e){a(e)}}function s(e){try{d(r.throw(e))}catch(e){a(e)}}function d(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,s)}d((r=r.apply(e,t||[])).next())}))},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};const a=i(0),o=n(i(43)),s=i(44),d=n(i(12)),l=i(6),u=n(i(5)),c=i(1);e.exports=new class{addCall(e){return r(this,void 0,void 0,(function*(){return yield Promise.all([...e.map(e=>{const t=+new Date;return o.default.create({carId:e,type:s.CarStatistic.Type.call,date:t,content:""})})]),{carIds:e}}))}createCarShowing(e,t){return r(this,void 0,void 0,(function*(){if(!t.date||!t.status||!t.clientId)throw new Error("Ошибка в параметрах создаваемого показа");const i=+new Date;return yield o.default.create({carId:e,type:s.CarStatistic.Type.showing,date:i,content:JSON.stringify(t)})}))}updateCarShowing(e,t,i){return r(this,void 0,void 0,(function*(){if(!i.date||!i.status||!i.clientId)throw new Error("Ошибка в параметрах редактируемого показа");const r=(yield o.default.find({carId:[""+t],type:[""+s.CarStatistic.Type.showing]})).find(t=>{const r=JSON.parse(t.content);return t.id===e&&r.clientId===i.clientId});if(!r)throw new Error("Показ этому клиенту не найден");return yield o.default.updateById(r.id,{content:JSON.stringify(i)})}))}getCarShowingStatistic(e){return r(this,void 0,void 0,(function*(){return(yield o.default.find({carId:[""+e],type:[""+s.CarStatistic.Type.showing]})).map(e=>Object.assign(Object.assign({},e),{content:JSON.parse(e.content)}))}))}getAllCarStatistic(e){return r(this,void 0,void 0,(function*(){const t=yield o.default.find({carId:[""+e]}),i=t.filter(e=>e.type===s.CarStatistic.Type.showing).map(e=>Object.assign(Object.assign({},e),{content:JSON.parse(e.content)})).filter(e=>e.content.status!==s.CarStatistic.ShowingStatus.cancel).map(e=>(e.content.status===s.CarStatistic.ShowingStatus.success&&(e.date=e.content.date),e)),r=t.filter(e=>e.type===s.CarStatistic.Type.customerDiscount).map(e=>Object.assign(Object.assign({},e),{content:JSON.parse(e.content)}));return[...i,...t.filter(e=>e.type===s.CarStatistic.Type.call||e.type===s.CarStatistic.Type.customerCall),...r]}))}addCustomerCall(e){return r(this,void 0,void 0,(function*(){const t=+new Date;yield o.default.create({carId:e,type:s.CarStatistic.Type.customerCall,date:t,content:""});const i=yield d.default.findOne({name:[""+l.FieldNames.Car.dateOfLastCustomerCall]});return yield u.default.update({value:""+t},{fieldId:[""+i.id],sourceId:[""+e],sourceName:[""+a.Models.CARS_TABLE_NAME]}),{carId:e}}))}addCustomerDiscount(e,t,i){return r(this,void 0,void 0,(function*(){const r=yield d.default.findOne({name:[""+l.FieldNames.Car.carOwnerPrice]}),n=yield u.default.findOne({fieldId:[""+r.id],sourceId:[""+e],sourceName:[""+a.Models.CARS_TABLE_NAME]});if(i!==+n.value)throw c.ApiError.BadRequest("Цена из запроса и цена из машины не сходяться.");const f=+new Date;return yield o.default.create({carId:e,type:s.CarStatistic.Type.customerDiscount,date:f,content:JSON.stringify({amount:i,discount:t})}),yield u.default.updateById(n.id,{value:""+(+n.value-t)}),{carId:e}}))}}},function(e,t,i){"use strict";const r=i(0),n=i(2);class a extends n.BaseRepository{constructor(){super(r.Models.CAR_OWNERS_TABLE_NAME)}}e.exports=new a},function(e,t,i){"use strict";const r=i(0),n=i(2);class a extends n.BaseRepository{constructor(){super(r.Models.CARS_TABLE_NAME)}}e.exports=new a},function(e,t,i){"use strict";const r=i(0),n=i(2);class a extends n.BaseRepository{constructor(){super(r.Models.CLIENTS_TABLE_NAME)}}e.exports=new a},function(e,t,i){"use strict";const r=i(0),n=i(2);class a extends n.BaseRepository{constructor(){super(r.Models.FIELD_ACCESSES_TABLE_NAME)}}e.exports=new a},function(e,t,i){"use strict";var r=this&&this.__awaiter||function(e,t,i,r){return new(i||(i=Promise))((function(n,a){function o(e){try{d(r.next(e))}catch(e){a(e)}}function s(e){try{d(r.throw(e))}catch(e){a(e)}}function d(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,s)}d((r=r.apply(e,t||[])).next())}))},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};const a=n(i(23)),o=i(24),s=n(i(25)),d=i(0),l=i(1),u=n(i(14)),c=n(i(9)),f=i(7),m=n(i(5)),p=i(13),y=n(i(8)),h=n(i(15));e.exports=new class{getAll(){return r(this,void 0,void 0,(function*(){const[e,t]=yield Promise.all([u.default.getAll(),c.default.getFieldsByDomain(f.FieldDomains.User)]),i=yield m.default.find({sourceId:e.map(e=>""+e.id),sourceName:[""+d.Models.USERS_TABLE_NAME]}),r=yield h.default.getAll();return e.map(e=>{var n;return{id:e.id,email:e.email,password:e.password,isActivated:e.isActivated,activationLink:e.activationLink,roleLevel:e.roleLevel,customRoleName:(null===(n=r.find(t=>t.id+1e3===e.roleLevel))||void 0===n?void 0:n.systemName)||"",fields:(0,p.getFieldsWithValues)(t,i,e.id)}})}))}create(e){return r(this,void 0,void 0,(function*(){if(yield u.default.findOne({email:[e.email]}))throw l.ApiError.BadRequest(`User with ${e.email} exists`);const t=(0,o.v4)();e.password=yield a.default.hash(e.password,3),e.isActivated||(e=Object.assign({},e,{activationLink:t}));const i=[...e.fields];delete e.fields;const r=yield u.default.create(e);return yield Promise.all(i.map(e=>y.default.createFieldChain({sourceId:r.id,fieldId:e.id,value:e.value,sourceName:d.Models.USERS_TABLE_NAME}))),e.isActivated||(yield s.default.sendActivationMail(e.email,process.env.API_URL+"/activate/"+t)),r}))}update(e,t){return r(this,void 0,void 0,(function*(){t.password&&(t.password=yield a.default.hash(t.password,3));const i=[...t.fields];delete t.fields;const r=yield u.default.updateById(e,t);return yield Promise.all(i.map(t=>m.default.update({value:t.value},{fieldId:[t.id].map(e=>""+e),sourceId:[e].map(e=>""+e),sourceName:[d.Models.USERS_TABLE_NAME]}))),r}))}delete(e){return r(this,void 0,void 0,(function*(){const t=yield m.default.find({sourceId:[""+e],sourceName:[d.Models.USERS_TABLE_NAME]});yield Promise.all(t.map(e=>y.default.deleteFieldChain(e.id)));return yield u.default.deleteById(e)}))}get(e){var t;return r(this,void 0,void 0,(function*(){const i=yield u.default.findById(e),r=yield c.default.getFieldsByDomain(f.FieldDomains.User),n=yield m.default.find({sourceId:[""+e],sourceName:[""+d.Models.USERS_TABLE_NAME]}),a=yield h.default.getAll();return{id:i.id,email:i.email,isActivated:i.isActivated,roleLevel:i.roleLevel,customRoleName:(null===(t=a.find(e=>e.id+1e3===i.roleLevel))||void 0===t?void 0:t.systemName)||"",fields:(0,p.getFieldsWithValues)(r,n,i.id)}}))}}},function(e,t){e.exports=require("bcrypt")},function(e,t){e.exports=require("uuid")},function(e,t,i){"use strict";var r=this&&this.__awaiter||function(e,t,i,r){return new(i||(i=Promise))((function(n,a){function o(e){try{d(r.next(e))}catch(e){a(e)}}function s(e){try{d(r.throw(e))}catch(e){a(e)}}function d(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,s)}d((r=r.apply(e,t||[])).next())}))};const n=(this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}})(i(50));e.exports=new class{constructor(){this.transporter=n.default.createTransport({host:process.env.SMTP_HOST,port:process.env.SMTP_PORT,secure:!1,auth:{user:process.env.SMTP_USER,pass:process.env.SMTP_PASSWORD}})}sendActivationMail(e,t){return r(this,void 0,void 0,(function*(){throw new Error("Not implemented")}))}}},function(e,t,i){"use strict";var r=this&&this.__awaiter||function(e,t,i,r){return new(i||(i=Promise))((function(n,a){function o(e){try{d(r.next(e))}catch(e){a(e)}}function s(e){try{d(r.throw(e))}catch(e){a(e)}}function d(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,s)}d((r=r.apply(e,t||[])).next())}))},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};const a=n(i(62)),o=n(i(63));e.exports=new class{generateTokens(e){return{accessToken:a.default.sign(e,process.env.JWT_ACCESS_SECRET,{expiresIn:"30m"}),refreshToken:a.default.sign(e,process.env.JWT_REFRESH_SECRET,{expiresIn:"30d"})}}validateAccessToken(e){try{return a.default.verify(e,process.env.JWT_ACCESS_SECRET)}catch(e){return null}}validateRefreshToken(e){try{return a.default.verify(e,process.env.JWT_REFRESH_SECRET)}catch(e){return null}}saveToken(e,t){return r(this,void 0,void 0,(function*(){const i=yield o.default.findOne({userId:[""+e]});if(i)return i.refreshToken=t,yield o.default.updateById(i.id,i);return yield o.default.create({userId:e,refreshToken:t})}))}removeToken(e){return r(this,void 0,void 0,(function*(){return o.default.deleteOne({refreshToken:[""+e]})}))}findToken(e){return r(this,void 0,void 0,(function*(){return o.default.findOne({refreshToken:[""+e]})}))}}},function(e,t,i){"use strict";var r=this&&this.__awaiter||function(e,t,i,r){return new(i||(i=Promise))((function(n,a){function o(e){try{d(r.next(e))}catch(e){a(e)}}function s(e){try{d(r.throw(e))}catch(e){a(e)}}function d(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,s)}d((r=r.apply(e,t||[])).next())}))},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=i(28);n(i(16));const o=process.env.PORT||3080;!function(){r(this,void 0,void 0,(function*(){const e=new a.App(o);yield e.listen()}))}()},function(e,t,i){"use strict";var r=this&&this.__awaiter||function(e,t,i,r){return new(i||(i=Promise))((function(n,a){function o(e){try{d(r.next(e))}catch(e){a(e)}}function s(e){try{d(r.throw(e))}catch(e){a(e)}}function d(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,s)}d((r=r.apply(e,t||[])).next())}))},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.App=void 0;const a=n(i(4)),o=n(i(29)),s=(n(i(30)),n(i(31))),d=n(i(33)),l=n(i(51)),u=n(i(53)),c=n(i(56)),f=n(i(59)),m=n(i(64)),p=i(69),y=n(i(70));t.App=class{constructor(e){this.port=e,this.routes=()=>{this.app.use(a.default.static(process.cwd()+"/build/ui/zubr-auto/")),this.app.use("/uploads/",a.default.static(process.cwd()+"/build/uploads/")),this.app.use(s.default),this.app.use("/cars",d.default),this.app.use("/fields",l.default),this.app.use("/clients",u.default),this.app.use("/auth",m.default),this.app.use("/roles",c.default),this.app.use("/users",f.default)},this.app=(0,a.default)(),this.settings(),this.middlewares(this.routes)}settings(){this.app.set("port",this.port||process.env.PORT||3080)}middlewares(e){this.app.use((0,y.default)({})),this.app.use(a.default.json()),this.app.use((0,o.default)()),e(),this.app.use(p.errorMiddleware)}listen(){return r(this,void 0,void 0,(function*(){yield this.app.listen(this.app.get("port")),console.log("Server on port",this.app.get("port"))}))}}},function(e,t){e.exports=require("cookie-parser")},function(e,t){e.exports=require("cors")},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=i(4),n=i(32),a=(0,r.Router)();a.route("/").get(n.indexWelcome),t.default=a},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.indexWelcome=void 0,t.indexWelcome=function(e,t){t.sendFile(process.cwd()+"build/ui/zubr-auto/index.html")}},function(e,t,i){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=i(4),a=i(3),o=r(i(34)),s=i(10),d=(0,n.Router)();d.route(`/${s.Constants.API.CRUD}/`).get(o.default.getAllCars).post(o.default.createCar),d.route(`/${s.Constants.API.CRUD}/:carId`).get(o.default.getCar).delete(o.default.deleteCar).put(o.default.updateCar),d.route(`/${s.Constants.API.STATISTIC}/${s.Constants.API.ADD_CUSTOMER_CALL}/:carId`).post(o.default.addCustomerCall),d.route(`/${s.Constants.API.STATISTIC}/${s.Constants.API.ADD_CUSTOMER_DISCOUNT}/:carId`).post((0,a.body)("amount").isNumeric(),(0,a.body)("discount").isNumeric(),o.default.addCustomerDiscount),d.route(`/${s.Constants.API.STATISTIC}/${s.Constants.API.ADD_CALL}`).post(o.default.addCall),d.route(`/${s.Constants.API.STATISTIC}/:carId`).get(o.default.getAllCarStatistic),d.route(`/${s.Constants.API.STATISTIC}/${s.Constants.API.CAR_SHOWING}/:carId`).get(o.default.getCarStatistic).post(o.default.createCarShowing).put((0,a.body)("showingId").notEmpty().isNumeric(),(0,a.body)("showingContent").notEmpty().isObject(),o.default.updateCarShowing),d.route("/"+s.Constants.API.CREATE_CARS_BY_LINK).post(o.default.createCarsByLink),d.route(`/${s.Constants.API.IMAGES}/:carId`).get(o.default.getImages),d.route(`/${s.Constants.API.IMAGES}/:carId/:imageId`).delete(o.default.deleteCarImage),d.route("/"+s.Constants.API.IMAGES).post(o.default.uploadImages),d.route("/"+s.Constants.API.STATE_IMAGES).post(o.default.uploadStateImages),d.route("/"+s.Constants.API.IMAGE360).post(o.default.uploadImage360),t.default=d},function(e,t,i){"use strict";var r=this&&this.__awaiter||function(e,t,i,r){return new(i||(i=Promise))((function(n,a){function o(e){try{d(r.next(e))}catch(e){a(e)}}function s(e){try{d(r.throw(e))}catch(e){a(e)}}function d(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,s)}d((r=r.apply(e,t||[])).next())}))},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};const a=i(3),o=i(1),s=n(i(35)),d=n(i(17)),l=n(i(45));e.exports=new class{constructor(){this.getAllCars=(e,t,i)=>r(this,void 0,void 0,(function*(){try{const i=(0,a.validationResult)(e);if(!i.isEmpty())throw o.ApiError.BadRequest("Ошибка при валидации",i.array());const r=yield l.default.getAll();return t.json(r)}catch(e){i(e)}}))}createCar(e,t,i){return r(this,void 0,void 0,(function*(){try{const i=(0,a.validationResult)(e);if(!i.isEmpty())throw o.ApiError.BadRequest("Ошибка при валидации",i.array());const r=e.body,n=yield l.default.create(r);return t.json(n)}catch(e){i(e)}}))}getCar(e,t,i){return r(this,void 0,void 0,(function*(){try{const i=(0,a.validationResult)(e);if(!i.isEmpty())throw o.ApiError.BadRequest("Ошибка при валидации",i.array());const r=+e.params.carId,n=yield l.default.get(r);return t.json(n)}catch(e){i(e)}}))}deleteCar(e,t,i){return r(this,void 0,void 0,(function*(){try{const i=(0,a.validationResult)(e);if(!i.isEmpty())throw o.ApiError.BadRequest("Ошибка при валидации",i.array());const r=+e.params.carId,n=yield l.default.delete(r);return t.json(n)}catch(e){i(e)}}))}updateCar(e,t,i){return r(this,void 0,void 0,(function*(){try{const i=(0,a.validationResult)(e);if(!i.isEmpty())throw o.ApiError.BadRequest("Ошибка при валидации",i.array());const r=+e.params.carId,n=e.body,s=yield l.default.update(r,n);return t.json(s)}catch(e){i(e)}}))}createCarsByLink(e,t,i){return r(this,void 0,void 0,(function*(){try{const i=(0,a.validationResult)(e);if(!i.isEmpty())throw o.ApiError.BadRequest("Ошибка при валидации",i.array());const r=e.body,n=yield l.default.createCarsByLink(r);return t.json(n)}catch(e){i(e)}}))}getImages(e,t,i){return r(this,void 0,void 0,(function*(){try{const i=(0,a.validationResult)(e);if(!i.isEmpty())throw o.ApiError.BadRequest("Ошибка при валидации",i.array());const r=+e.params.carId,n=yield s.default.getCarFiles(r);return t.json(n)}catch(e){i(e)}}))}deleteCarImage(e,t,i){return r(this,void 0,void 0,(function*(){try{const i=(0,a.validationResult)(e);if(!i.isEmpty())throw o.ApiError.BadRequest("Ошибка при валидации",i.array());const r=+e.params.carId,n=+e.params.imageId;yield s.default.deleteCarImage(r,n);return t.json(!0)}catch(e){i(e)}}))}uploadImages(e,t,i){return r(this,void 0,void 0,(function*(){try{const i=(0,a.validationResult)(e);if(!i.isEmpty())throw o.ApiError.BadRequest("Ошибка при валидации",i.array());const r=e.files.file;let n=Array.isArray(r)?r:[r];const d=+e.body.carId,l=e.body.metadata||"{}",u=yield s.default.uploadCarImage(d,n,l);return t.json(u)}catch(e){console.log(e),i(e)}}))}uploadStateImages(e,t,i){return r(this,void 0,void 0,(function*(){try{const i=(0,a.validationResult)(e);if(!i.isEmpty())throw o.ApiError.BadRequest("Ошибка при валидации",i.array());const r=e.files.file;let n=Array.isArray(r)?r:[r];const d=+e.body.carId,l=e.body.metadata||"{}",u=yield s.default.uploadCarStateImages(d,n,l);return t.json(u)}catch(e){console.log(e),i(e)}}))}uploadImage360(e,t,i){return r(this,void 0,void 0,(function*(){try{const i=(0,a.validationResult)(e);if(!i.isEmpty())throw o.ApiError.BadRequest("Ошибка при валидации",i.array());const r=e.files.file;let n=Array.isArray(r)?r:[r];const d=+e.body.carId,l=e.body.metadata||"{}",u=yield s.default.uploadCarImage360(d,n[0],l);return t.json(u)}catch(e){console.log(e),i(e)}}))}addCall(e,t,i){return r(this,void 0,void 0,(function*(){try{const i=(0,a.validationResult)(e);if(!i.isEmpty())throw o.ApiError.BadRequest("Ошибка при валидации",i.array());const r=e.body.carIds,n=yield d.default.addCall(r);return t.json(n)}catch(e){i(e)}}))}addCustomerCall(e,t,i){return r(this,void 0,void 0,(function*(){try{const i=(0,a.validationResult)(e);if(!i.isEmpty())throw o.ApiError.BadRequest("Ошибка при валидации",i.array());const r=+e.params.carId,n=yield d.default.addCustomerCall(r);return t.json(n)}catch(e){i(e)}}))}addCustomerDiscount(e,t,i){return r(this,void 0,void 0,(function*(){try{const i=(0,a.validationResult)(e);if(!i.isEmpty())throw o.ApiError.BadRequest("Ошибка при валидации",i.array());const r=+e.params.carId,n=+e.body.discount,s=+e.body.amount,l=yield d.default.addCustomerDiscount(r,n,s);return t.json(l)}catch(e){i(e)}}))}createCarShowing(e,t,i){return r(this,void 0,void 0,(function*(){try{const i=(0,a.validationResult)(e);if(!i.isEmpty())throw o.ApiError.BadRequest("Ошибка при валидации",i.array());const r=+e.params.carId,n=e.body.showingContent,s=yield d.default.createCarShowing(r,n);return t.json(s)}catch(e){i(e)}}))}updateCarShowing(e,t,i){return r(this,void 0,void 0,(function*(){try{const i=(0,a.validationResult)(e);if(!i.isEmpty())throw o.ApiError.BadRequest("Ошибка при валидации",i.array());const r=+e.params.carId,n=e.body.showingId,s=e.body.showingContent,l=yield d.default.updateCarShowing(n,r,s);return t.json(l)}catch(e){i(e)}}))}getCarStatistic(e,t,i){return r(this,void 0,void 0,(function*(){try{const i=(0,a.validationResult)(e);if(!i.isEmpty())throw o.ApiError.BadRequest("Ошибка при валидации",i.array());const r=+e.params.carId,n=yield d.default.getCarShowingStatistic(r);return t.json(n)}catch(e){i(e)}}))}getAllCarStatistic(e,t,i){return r(this,void 0,void 0,(function*(){try{const i=(0,a.validationResult)(e);if(!i.isEmpty())throw o.ApiError.BadRequest("Ошибка при валидации",i.array());const r=+e.params.carId,n=yield d.default.getAllCarStatistic(r);return t.json(n)}catch(e){i(e)}}))}}},function(e,t,i){"use strict";var r=this&&this.__awaiter||function(e,t,i,r){return new(i||(i=Promise))((function(n,a){function o(e){try{d(r.next(e))}catch(e){a(e)}}function s(e){try{d(r.throw(e))}catch(e){a(e)}}function d(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,s)}d((r=r.apply(e,t||[])).next())}))},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};const a=n(i(36)),o=i(0),s=i(39),d=n(i(40)),l=n(i(42));e.exports=new class{uploadCarImage(e,t,i){return r(this,void 0,void 0,(function*(){const i=["image/png","image/jpeg","image/jpg"];if(t.find(e=>!i.includes(e.mimetype)))throw new Error("Это не картинка");const r=yield Promise.all(t.map(e=>d.default.uploadFile(e))),n=yield Promise.all(r.map((e,i)=>{let r={};r.s3Information=e;const n={url:e.Location,type:s.ServerFile.Types.Image,name:t[i].name,parent:0,fileMetadata:JSON.stringify(r)};return a.default.create(n)}));return yield Promise.all(n.map(t=>l.default.create({sourceId:e,sourceName:o.Models.CARS_TABLE_NAME,fileId:t.id}))),n}))}uploadCarStateImages(e,t,i){return r(this,void 0,void 0,(function*(){const i=["image/png","image/jpeg","image/jpg"];if(t.find(e=>!i.includes(e.mimetype)))throw new Error("Это не картинка");const r=yield Promise.all(t.map(e=>d.default.uploadFile(e))),n=yield Promise.all(r.map((e,i)=>{let r={};r.s3Information=e;const n={url:e.Location,type:s.ServerFile.Types.StateImage,name:t[i].name,parent:0,fileMetadata:JSON.stringify(r)};return a.default.create(n)}));return yield Promise.all(n.map(t=>l.default.create({sourceId:e,sourceName:o.Models.CARS_TABLE_NAME,fileId:t.id}))),n}))}uploadCarImage360(e,t,i){return r(this,void 0,void 0,(function*(){if(!["image/png","image/jpeg","image/jpg"].includes(t.mimetype))throw new Error("Это не картинка");const i=yield l.default.find({sourceName:[""+o.Models.CARS_TABLE_NAME],sourceId:[""+e]}),r=(yield a.default.getAll()).find(t=>t.type===s.ServerFile.Types.Image360&&i.find(t=>t.sourceId===e));r&&(yield this.deleteCarImage(e,r.id));const n=yield d.default.uploadFile(t);let u={};u.s3Information=n;const c={url:n.Location,type:s.ServerFile.Types.Image360,name:t.name,parent:0,fileMetadata:JSON.stringify(u)},f=yield a.default.create(c);return yield l.default.create({sourceId:e,sourceName:o.Models.CARS_TABLE_NAME,fileId:f.id}),f}))}getFiles(e=null){return r(this,void 0,void 0,(function*(){const t={sourceName:[""+o.Models.CARS_TABLE_NAME]};e&&(t.sourceId=[""+e]);const[i,r]=yield Promise.all([a.default.getAll(),l.default.find(t)]),n=r.map(e=>e.fileId);return i.filter(e=>n.includes(e.id)).map(e=>e)}))}getCarFiles(e){return r(this,void 0,void 0,(function*(){try{return yield this.getFiles(e)}catch(e){return console.log(e),[]}}))}deleteCarImage(e,t){return r(this,void 0,void 0,(function*(){yield l.default.deleteOne({fileId:[""+t],sourceName:[""+o.Models.CARS_TABLE_NAME],sourceId:[""+e]});return yield a.default.deleteById(t)}))}}},function(e,t,i){"use strict";var r=this&&this.__awaiter||function(e,t,i,r){return new(i||(i=Promise))((function(n,a){function o(e){try{d(r.next(e))}catch(e){a(e)}}function s(e){try{d(r.throw(e))}catch(e){a(e)}}function d(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,s)}d((r=r.apply(e,t||[])).next())}))};const n=i(0),a=i(11),o=i(2);class s extends o.BaseRepository{constructor(){super(n.Models.FILES_TABLE_NAME)}updateById(e,t){return r(this,void 0,void 0,(function*(){const i=(0,a.getUpdateByIdQuery)(this.tableName,e,t,!0);console.log(i);const r=yield this.query(i);return this.getOneRow(r)}))}update(e,t){return r(this,void 0,void 0,(function*(){const i=(0,a.getUpdateByAndExpressionQuery)(this.tableName,e,t,!0);console.log(i);const r=yield this.query(i);return this.getOneRow(r)}))}}e.exports=new s},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.db=void 0;const r=i(38);t.db=new r.Pool({host:"ec2-52-2-118-38.compute-1.amazonaws.com",user:"sprseivmltxfdq",port:5432,ssl:{rejectUnauthorized:!1},database:"dc0tjv7m1flhff",password:"ce7c5f45fd20b65707370ab84f41d7f7335965309c47cfb09a675a86dc25ad36",connectionString:process.env.DATABASE_URL})},function(e,t){e.exports=require("pg")},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ServerFile=void 0,function(e){let t;!function(e){e[e.Folder=0]="Folder",e[e.File=1]="File",e[e.Image=2]="Image",e[e.Image360=3]="Image360",e[e.StateImage=4]="StateImage"}(t=e.Types||(e.Types={}))}(t.ServerFile||(t.ServerFile={}))},function(e,t,i){"use strict";var r=this&&this.__awaiter||function(e,t,i,r){return new(i||(i=Promise))((function(n,a){function o(e){try{d(r.next(e))}catch(e){a(e)}}function s(e){try{d(r.throw(e))}catch(e){a(e)}}function d(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,s)}d((r=r.apply(e,t||[])).next())}))},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};const a=n(i(41));n(i(16));const o=process.env.AWS_BUCKET_NAME,s=process.env.AWS_BUCKET_REGION,d=process.env.AWS_ACCESS_KEY,l=process.env.AWS_SECRET_KEY;e.exports=new class{constructor(){this.s3=new a.default({region:s,accessKeyId:d,secretAccessKey:l})}uploadFile(e){return r(this,void 0,void 0,(function*(){const t=(new Date).getTime().toString(),i={Bucket:o,Body:e.data,Key:`${t}-${e.name}`};return this.s3.upload(i).promise()}))}}},function(e,t){e.exports=require("aws-sdk/clients/s3")},function(e,t,i){"use strict";const r=i(0),n=i(2);class a extends n.BaseRepository{constructor(){super(r.Models.FILE_CHAINS_TABLE_NAME)}}e.exports=new a},function(e,t,i){"use strict";const r=i(0),n=i(2);class a extends n.BaseRepository{constructor(){super(r.Models.CAR_STATISTIC_TABLE_NAME)}}e.exports=new a},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CarStatistic=void 0,function(e){let t,i;!function(e){e[e.call=0]="call",e[e.showing=1]="showing",e[e.customerCall=2]="customerCall",e[e.customerDiscount=3]="customerDiscount"}(t=e.Type||(e.Type={})),function(e){e.cancel="Отмена",e.plan="Запланирован",e.success="Произведен"}(i=e.ShowingStatus||(e.ShowingStatus={}))}(t.CarStatistic||(t.CarStatistic={}))},function(e,t,i){"use strict";var r=this&&this.__awaiter||function(e,t,i,r){return new(i||(i=Promise))((function(n,a){function o(e){try{d(r.next(e))}catch(e){a(e)}}function s(e){try{d(r.throw(e))}catch(e){a(e)}}function d(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,s)}d((r=r.apply(e,t||[])).next())}))},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};const a=i(7),o=i(6),s=i(0),d=n(i(46)),l=n(i(18)),u=n(i(19)),c=n(i(5)),f=n(i(12)),m=i(13),p=n(i(48)),y=n(i(8)),h=n(i(9)),v=n(i(22));e.exports=new class{getAll(){return r(this,void 0,void 0,(function*(){const[e,t,i,r,n]=yield Promise.all([u.default.getAll(),h.default.getFieldsByDomain(a.FieldDomains.Car),l.default.getAll(),h.default.getFieldsByDomain(a.FieldDomains.CarOwner),d.default.getAll()]),[f,p]=yield Promise.all([yield c.default.find({sourceId:e.map(e=>""+e.id),sourceName:[""+s.Models.CARS_TABLE_NAME]}),yield c.default.find({sourceId:i.map(e=>""+e.id),sourceName:[""+s.Models.CAR_OWNERS_TABLE_NAME]})]),y=yield v.default.getAll();return e.map(e=>{var a;const d=n.find(t=>t.carId===e.id),l=t.find(e=>e.name===o.FieldNames.Car.worksheet),u=t.find(e=>e.name===o.FieldNames.Car.contactCenterSpecialistId),c=f.find(t=>t.fieldId===u.id&&t.sourceId===e.id&&t.sourceName===s.Models.CARS_TABLE_NAME),h=y.find(e=>e.id===+(c||{}).value),v=t.find(e=>e.name===o.FieldNames.Car.contactCenterSpecialist);d&&l&&f.forEach(t=>{t.fieldId===l.id&&t.sourceId===e.id&&t.sourceName===s.Models.CARS_TABLE_NAME&&(t.value=d.content)}),h&&v&&f.forEach(t=>{t.fieldId===v.id&&t.sourceId===e.id&&t.sourceName===s.Models.CARS_TABLE_NAME&&(t.value=JSON.stringify(h))});const g=(0,m.getFieldsWithValues)(t,f,e.id);return{id:e.id,createdDate:e.createdDate,ownerId:e.ownerId,ownerNumber:(null===(a=i.find(t=>t.id===e.ownerId))||void 0===a?void 0:a.number)||"",fields:[...g,...(0,m.getFieldsWithValues)(r,p,e.ownerId)]}})}))}getCarAndOwnerCarFields(e){return r(this,void 0,void 0,(function*(){const t=yield h.default.getFieldsByDomain(a.FieldDomains.CarOwner);return[e.fields.filter(e=>!!t.find(t=>t.id===e.id)),e.fields.filter(e=>!t.find(t=>t.id===e.id))]}))}create(e){return r(this,void 0,void 0,(function*(){const[t,i]=yield this.getCarAndOwnerCarFields(e),r=yield l.default.findOne({number:[""+e.ownerNumber]}),n=r?r.id:(yield l.default.create({number:e.ownerNumber})).id,a=yield u.default.find({ownerId:[""+((null==r?void 0:r.id)||-1)]});if(a.length>0){const t=yield f.default.find({name:[o.FieldNames.Car.mark,o.FieldNames.Car.model,o.FieldNames.Car.mileage]}),i=(yield Promise.all(a.map(e=>c.default.find({sourceId:[""+e.id],sourceName:[s.Models.CARS_TABLE_NAME],fieldId:t.map(e=>""+e.id)})))).reduce((function(e,t){return e.concat(t)})),r=t.map(e=>{var t,r;return Object.assign(Object.assign({},e),{carId:(null===(t=i.find(t=>t.fieldId===e.id))||void 0===t?void 0:t.sourceId)||-1,value:(null===(r=i.find(t=>t.fieldId===e.id))||void 0===r?void 0:r.value)||""})}).filter(e=>-1!==e.carId).filter(t=>{const i=e.fields.find(e=>e.id===t.id);return t.value===i.value});let n={};r.forEach(e=>{n[e.carId]?n[e.carId].push(e.id):n[e.carId]=[e.id]});let d=0;for(const e in n)if(Object.prototype.hasOwnProperty.call(n,e)){n[e].length>0&&++d}if(d>0)return{id:-1}}r?yield Promise.all(t.map(e=>c.default.update({value:e.value},{fieldId:[""+e.id],sourceId:[""+n],sourceName:[s.Models.CAR_OWNERS_TABLE_NAME]}))):yield Promise.all(t.map(e=>y.default.createFieldChain({sourceId:n,fieldId:e.id,value:e.value,sourceName:s.Models.CAR_OWNERS_TABLE_NAME})));const d=yield u.default.create({createdDate:""+(new Date).getTime(),ownerId:n});return yield Promise.all(i.map(e=>y.default.createFieldChain({sourceId:d.id,fieldId:e.id,value:e.value,sourceName:s.Models.CARS_TABLE_NAME}))),{id:d.id}}))}update(e,t){return r(this,void 0,void 0,(function*(){const[i,r]=yield this.getCarAndOwnerCarFields(t);let n=!1;const a=yield u.default.findById(e),f=yield l.default.findOne({id:[""+a.ownerId]}),m=t.ownerNumber?yield l.default.findOne({number:[""+t.ownerNumber]}):null;let p=f;!m&&t.ownerNumber?p=yield l.default.updateById(a.ownerId,{number:t.ownerNumber}):f&&m&&m.number!==f.number&&(t=Object.assign({},t,{ownerId:m.id}),p=m,n=!0),yield Promise.all(i.map(e=>c.default.update({value:e.value},{fieldId:[""+e.id],sourceId:[""+p.id],sourceName:[s.Models.CAR_OWNERS_TABLE_NAME]}))),n&&(delete t.fields,yield u.default.updateById(e,t));const y=r.find(e=>e.name===o.FieldNames.Car.worksheet);if(y&&y.value){const t=yield d.default.findOne({carId:[""+e]});t?yield d.default.updateById(t.id,{content:y.value}):yield d.default.create({carId:e,content:y.value})}const h=r.filter(e=>e.name!==o.FieldNames.Car.worksheet);return yield Promise.all(h.map(t=>c.default.update({value:t.value},{fieldId:[""+t.id],sourceId:[""+e],sourceName:[s.Models.CARS_TABLE_NAME]}))),{id:e}}))}delete(e){return r(this,void 0,void 0,(function*(){const t=yield c.default.find({sourceId:[""+e],sourceName:[s.Models.CARS_TABLE_NAME]});yield Promise.all(t.map(e=>y.default.deleteFieldChain(e.id)));return yield u.default.deleteById(e)}))}get(e){return r(this,void 0,void 0,(function*(){const[t,i,r]=yield Promise.all([u.default.findById(e),h.default.getFieldsByDomain(a.FieldDomains.Car),h.default.getFieldsByDomain(a.FieldDomains.CarOwner)]),n=yield l.default.findById(t.ownerId),[o,d]=yield Promise.all([yield c.default.find({sourceId:[""+t.id],sourceName:[""+s.Models.CARS_TABLE_NAME]}),yield c.default.find({sourceId:[""+n.id],sourceName:[""+s.Models.CAR_OWNERS_TABLE_NAME]})]);return{id:t.id,createdDate:t.createdDate,ownerId:t.ownerId,ownerNumber:n.number,fields:[...(0,m.getFieldsWithValues)(i,o,t.id),...(0,m.getFieldsWithValues)(r,d,t.ownerId)]}}))}createCarsByLink(e){return r(this,void 0,void 0,(function*(){const[t,i]=yield Promise.all([h.default.getFieldsByDomain(a.FieldDomains.Car),h.default.getFieldsByDomain(a.FieldDomains.CarOwner)]),r=e.link.split("?")[1],n=yield p.default.getCarsInfo(r,t,i,e.userId);if(0===n.length)return[];return(yield Promise.all(n.map(e=>this.create(e)))).map((e,t)=>{if(-1===e.id){const e=n[t];return Object.assign(Object.assign({},e),{id:-1})}return Object.assign({},e)})}))}}},function(e,t,i){"use strict";const r=i(0),n=i(2);class a extends n.BaseRepository{constructor(){super(r.Models.CAR_FORMS_TABLE_NAME)}}e.exports=new a},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BitHelper=void 0,function(e){e.setOn=function(e,t){return e|t},e.setOff=function(e,t){return e&~t},e.Is=function(e,t){return(e&t)===t}}(t.BitHelper||(t.BitHelper={}))},function(e,t,i){"use strict";var r=this&&this.__awaiter||function(e,t,i,r){return new(i||(i=Promise))((function(n,a){function o(e){try{d(r.next(e))}catch(e){a(e)}}function s(e){try{d(r.throw(e))}catch(e){a(e)}}function d(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,s)}d((r=r.apply(e,t||[])).next())}))};const n=(this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}})(i(49)),a=i(6);var o;!function(e){e.brand="brand",e.model="model",e.generation="generation",e.year="year",e.engine_capacity="engine_capacity",e.engine_type="engine_type",e.transmission_type="transmission_type",e.generation_with_years="generation_with_years",e.railings="railings",e.abs="abs",e.esp="esp",e.anti_slip_system="anti_slip_system",e.immobilizer="immobilizer",e.alarm="alarm",e.front_safebags="front_safebags",e.side_safebags="side_safebags",e.rear_safebags="rear_safebags",e.rain_detector="rain_detector",e.rear_view_camera="rear_view_camera",e.parktronics="parktronics",e.mirror_dead_zone_control="mirror_dead_zone_control",e.interior_color="interior_color",e.interior_material="interior_material",e.drive_auto_start="drive_auto_start",e.cruise_control="cruise_control",e.steering_wheel_media_control="steering_wheel_media_control",e.electro_seat_adjustment="electro_seat_adjustment",e.front_glass_lift="front_glass_lift",e.rear_glass_lift="rear_glass_lift",e.seat_heating="seat_heating",e.front_glass_heating="front_glass_heating",e.mirror_heating="mirror_heating",e.autonomous_heater="autonomous_heater",e.climate_control="climate_control",e.aux_ipod="aux_ipod",e.bluetooth="bluetooth",e.cd_mp3_player="cd_mp3_player",e.usb="usb",e.media_screen="media_screen",e.navigator="navigator",e.xenon_lights="xenon_lights",e.fog_lights="fog_lights",e.led_lights="led_lights",e.body_type="body_type",e.drive_type="drive_type",e.color="color",e.mileage_km="mileage_km",e.condition="condition"}(o||(o={}));e.exports=new class{getCarsInfo(e,t,i,n){return r(this,void 0,void 0,(function*(){const r=process.env.CARS_INFO_LINK,a=e.split("&").filter(e=>!e.match("page")).join("&"),o=yield this.get(`${r}?${a}`);let s=[];for(let e=2;e<o.pageCount+1;e++)s.push(`${r}?${a}&page=${e}`);let d=[];s.length>0&&(d=yield Promise.all(s.map((e,t)=>this.getResponseFromLink(e,300*t))));const l=o.adverts.filter(e=>!(e.organizationId||e.organizationTitle));d.forEach(e=>{l.push(...e.adverts.filter(e=>!(e.organizationId||e.organizationTitle)))});const u=l.map(e=>e.id),c=yield Promise.all(u.map((e,t)=>this.getResponseFromLink((e=>`${process.env.CARS_PHONE_LINK}/${e}/phones`)(e),100*t).then(t=>{var i;const r=(null===(i=t.find(e=>1===e.country.id))||void 0===i?void 0:i.number)||0;return{id:e,number:r}})));return this.converCarsInfoToServerCars(l,c.map(e=>({id:e.id,number:+e.number})),t,i,n)}))}getResponseFromLink(e,t){return r(this,void 0,void 0,(function*(){return new Promise((i,r)=>{setTimeout(()=>{this.get(e).then(e=>{i(e)}).catch(e=>{r(e)})},t)})}))}get(e){return r(this,void 0,void 0,(function*(){return yield n.default.get(e).then(e=>JSON.parse(e))}))}converCarsInfoToServerCars(e,t,i,r,n){return e.map(e=>{var a;const o=(null===(a=t.find(t=>t.id===e.id))||void 0===a?void 0:a.number)||0;return o?{ownerNumber:"+375"+o,fields:[...i,...r].map(t=>({id:t.id,name:t.name,value:this.getCarFieldValue(t,e,n)}))}:null}).filter(e=>!!e)}getCarFieldValue(e,t,i){var r,n,o,s,d,l;const u=e.name;switch(u){case a.FieldNames.Car.engine:{const i=""+((null===(r=t.properties.find(e=>e.name===this.getPropertyName(u)))||void 0===r?void 0:r.value)||""),n=this.convertEngineType(i),o=e.variants.split(",").findIndex(e=>e===n);return-1===o?"":`${a.FieldNames.Car.engine}-${o}`}case a.FieldNames.Car.engineCapacity:{const e=""+((null===(n=t.properties.find(e=>e.name===this.getPropertyName(u)))||void 0===n?void 0:n.value)||"");return this.convertEngineCapacity(e)}case a.FieldNames.Car.transmission:{const i=""+((null===(o=t.properties.find(e=>e.name===this.getPropertyName(u)))||void 0===o?void 0:o.value)||""),r=this.convertTransmission(i),n=e.variants.split(",").findIndex(e=>e===r);return-1===n?"":`${a.FieldNames.Car.transmission}-${n}`}case a.FieldNames.Car.bodyType:{const i=""+((null===(s=t.properties.find(e=>e.name===this.getPropertyName(u)))||void 0===s?void 0:s.value)||""),r=e.variants.split(",").findIndex(e=>e===i);return-1===r?"":`${a.FieldNames.Car.bodyType}-${r}`}case a.FieldNames.Car.driveType:{const i=""+((null===(d=t.properties.find(e=>e.name===this.getPropertyName(u)))||void 0===d?void 0:d.value)||""),r=this.convertDriveType(i),n=e.variants.split(",").findIndex(e=>e===r);return-1===n?"":`${a.FieldNames.Car.driveType}-${n}`}case a.FieldNames.Car.linkToAd:return t.publicUrl;case a.FieldNames.Car.carOwnerPrice:return""+t.price.usd.amount;case a.FieldNames.Car.contactCenterSpecialistId:return""+i;case a.FieldNames.CarOwner.name:return""+t.sellerName;case a.FieldNames.Car.status:return"status-0";case a.FieldNames.Car.source:return["a","v",".","b","y"].join("")}return""+((null===(l=t.properties.find(e=>e.name===this.getPropertyName(u)))||void 0===l?void 0:l.value)||"")}getPropertyName(e){switch(e){case a.FieldNames.Car.mark:return o.brand;case a.FieldNames.Car.model:return o.model;case a.FieldNames.Car.driveType:return o.drive_type;case a.FieldNames.Car.bodyType:return o.body_type;case a.FieldNames.Car.engine:return o.engine_type;case a.FieldNames.Car.engineCapacity:return o.engine_capacity;case a.FieldNames.Car.mileage:return o.mileage_km;case a.FieldNames.Car.year:return o.year;case a.FieldNames.Car.transmission:return o.transmission_type;case a.FieldNames.Car.color:return o.color}return""}convertEngineType(e){switch(e){case"дизель":case"дизель (гибрид)":return"Дизель";case"бензин":case"бензин (пропан-бутан)":case"бензин (метан)":case"бензин (гибрид)":return"Бензин";case"электро":return"Электро"}return e}convertEngineCapacity(e){return e}convertTransmission(e){switch(e){case"автомат":return"Автомат";case"механика":return"Механика"}return e}convertDriveType(e){switch(e){case"передний привод":return"Передний";case"задний привод":return"Задний";case"подключаемый полный привод":case"постоянный полный привод":return"Полный"}return e}}},function(e,t){e.exports=require("request-promise")},function(e,t){e.exports=require("nodemailer")},function(e,t,i){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=i(4),a=i(3),o=r(i(52)),s=i(10),d=(0,n.Router)();d.route(`/${s.Constants.API.CRUD}/`).get(o.default.getAllFields).post((0,a.body)("name").isLength({min:3,max:50}),(0,a.body)("name").matches(/^[a-z][a-z-]{1,50}[a-z]$/),(0,a.body)("flags").isNumeric(),(0,a.body)("domain").isNumeric(),(0,a.body)("variants").isString(),(0,a.body)("showUserLevel").isNumeric(),o.default.createField),d.route(`/${s.Constants.API.CRUD}/:fieldId`).get(o.default.getField).delete(o.default.deleteField).put(o.default.updateField),d.route("/getFieldsByDomain/:domain").get(o.default.getFieldsByDomain),t.default=d},function(e,t,i){"use strict";var r=this&&this.__awaiter||function(e,t,i,r){return new(i||(i=Promise))((function(n,a){function o(e){try{d(r.next(e))}catch(e){a(e)}}function s(e){try{d(r.throw(e))}catch(e){a(e)}}function d(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,s)}d((r=r.apply(e,t||[])).next())}))},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};const a=i(3),o=i(1),s=n(i(9));e.exports=new class{getAllFields(e,t,i){return r(this,void 0,void 0,(function*(){try{const r=(0,a.validationResult)(e);if(!r.isEmpty())return i(o.ApiError.BadRequest("Ошибка при валидации",r.array()));const n=yield s.default.getAll();return t.json(n)}catch(e){i(e)}}))}createField(e,t,i){return r(this,void 0,void 0,(function*(){try{const r=(0,a.validationResult)(e);if(!r.isEmpty())return i(o.ApiError.BadRequest("Ошибка при валидации",r.array()));const n=e.body,d=yield s.default.create(n);return t.json({id:d.id})}catch(e){i(e)}}))}getField(e,t,i){return r(this,void 0,void 0,(function*(){try{const r=(0,a.validationResult)(e);if(!r.isEmpty())return i(o.ApiError.BadRequest("Ошибка при валидации",r.array()));const n=+e.params.fieldId,d=yield s.default.get(n);return t.json(d)}catch(e){i(e)}}))}deleteField(e,t,i){return r(this,void 0,void 0,(function*(){try{const r=(0,a.validationResult)(e);if(!r.isEmpty())return i(o.ApiError.BadRequest("Ошибка при валидации",r.array()));const n=+e.params.fieldId,d=yield s.default.delete(n);return t.json(d)}catch(e){i(e)}}))}updateField(e,t,i){return r(this,void 0,void 0,(function*(){try{const r=(0,a.validationResult)(e);if(!r.isEmpty())return i(o.ApiError.BadRequest("Ошибка при валидации",r.array()));const n=+e.params.fieldId,d=e.body,l=yield s.default.update(n,d);return t.json(l)}catch(e){i(e)}}))}getFieldsByDomain(e,t,i){return r(this,void 0,void 0,(function*(){try{const r=(0,a.validationResult)(e);if(!r.isEmpty())return i(o.ApiError.BadRequest("Ошибка при валидации",r.array()));const n=+e.params.domain,d=yield s.default.getFieldsByDomain(n);return t.json(d)}catch(e){i(e)}}))}}},function(e,t,i){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=i(4),a=i(3),o=r(i(54)),s=i(10),d=(0,n.Router)();d.route("/").get(o.default.getAllClient).post(o.default.createClient),d.route("/:clientId").get(o.default.getClient).delete(o.default.deleteClient).put(o.default.updateClient),d.route("/"+s.Constants.API.COMPLETE_DEAL).post((0,a.body)("clientId").isNumeric().notEmpty(),(0,a.body)("carId").isNumeric().notEmpty(),o.default.completeDeal),t.default=d},function(e,t,i){"use strict";var r=this&&this.__awaiter||function(e,t,i,r){return new(i||(i=Promise))((function(n,a){function o(e){try{d(r.next(e))}catch(e){a(e)}}function s(e){try{d(r.throw(e))}catch(e){a(e)}}function d(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,s)}d((r=r.apply(e,t||[])).next())}))},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};const a=i(3),o=i(1),s=n(i(55));e.exports=new class{getAllClient(e,t,i){return r(this,void 0,void 0,(function*(){try{const r=(0,a.validationResult)(e);if(!r.isEmpty())return i(o.ApiError.BadRequest("Ошибка при валидации",r.array()));const n=yield s.default.getAll();return t.json(n)}catch(e){i(e)}}))}getClient(e,t,i){return r(this,void 0,void 0,(function*(){try{const r=(0,a.validationResult)(e);if(!r.isEmpty())return i(o.ApiError.BadRequest("Ошибка при валидации",r.array()));const n=+e.params.clientId,d=yield s.default.get(n);return t.json(d)}catch(e){i(e)}}))}createClient(e,t,i){return r(this,void 0,void 0,(function*(){try{const r=(0,a.validationResult)(e);if(!r.isEmpty())return i(o.ApiError.BadRequest("Ошибка при валидации",r.array()));const n=e.body,d=yield s.default.create(n);return t.json(d)}catch(e){i(e)}}))}updateClient(e,t,i){return r(this,void 0,void 0,(function*(){try{const r=(0,a.validationResult)(e);if(!r.isEmpty())return i(o.ApiError.BadRequest("Ошибка при валидации",r.array()));const n=+e.params.clientId,d=e.body,l=yield s.default.update(n,d);return t.json(l)}catch(e){i(e)}}))}deleteClient(e,t,i){return r(this,void 0,void 0,(function*(){try{const r=(0,a.validationResult)(e);if(!r.isEmpty())return i(o.ApiError.BadRequest("Ошибка при валидации",r.array()));const n=+e.params.clientId,d=yield s.default.delete(n);return t.json(d)}catch(e){i(e)}}))}completeDeal(e,t,i){return r(this,void 0,void 0,(function*(){try{const r=(0,a.validationResult)(e);if(!r.isEmpty())return i(o.ApiError.BadRequest("Ошибка при валидации",r.array()));const{clientId:n,carId:d}=e.body,l=yield s.default.completeDeal(n,d);return t.json(l)}catch(e){i(e)}}))}}},function(e,t,i){"use strict";var r=this&&this.__awaiter||function(e,t,i,r){return new(i||(i=Promise))((function(n,a){function o(e){try{d(r.next(e))}catch(e){a(e)}}function s(e){try{d(r.throw(e))}catch(e){a(e)}}function d(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,s)}d((r=r.apply(e,t||[])).next())}))},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};const a=i(7),o=i(6),s=i(0),d=n(i(20)),l=n(i(5)),u=i(13),c=n(i(17)),f=n(i(8)),m=n(i(9));e.exports=new class{getAll(){return r(this,void 0,void 0,(function*(){const[e,t]=yield Promise.all([d.default.getAll(),m.default.getFieldsByDomain(a.FieldDomains.Client)]),i=yield l.default.find({sourceId:e.map(e=>""+e.id),sourceName:[""+s.Models.CLIENTS_TABLE_NAME]});return e.map(e=>({id:e.id,carIds:e.carIds,fields:(0,u.getFieldsWithValues)(t,i,e.id)}))}))}create(e){return r(this,void 0,void 0,(function*(){const t=yield d.default.create({carIds:e.carIds});return yield c.default.addCall(e.carIds.split(",").map(e=>+e)),yield Promise.all(e.fields.map(e=>f.default.createFieldChain({sourceId:t.id,fieldId:e.id,value:e.value,sourceName:s.Models.CLIENTS_TABLE_NAME}))),t}))}update(e,t){return r(this,void 0,void 0,(function*(){const i=yield d.default.updateById(e,{carIds:t.carIds});return yield Promise.all(t.fields.map(t=>l.default.update({value:t.value},{fieldId:[t.id].map(e=>""+e),sourceId:[e].map(e=>""+e),sourceName:[s.Models.CLIENTS_TABLE_NAME]}))),i}))}delete(e){return r(this,void 0,void 0,(function*(){const t=yield l.default.find({sourceId:[""+e],sourceName:[s.Models.CLIENTS_TABLE_NAME]});yield Promise.all(t.map(e=>f.default.deleteFieldChain(e.id)));return yield d.default.deleteById(e)}))}get(e){return r(this,void 0,void 0,(function*(){const t=yield d.default.findById(e),i=yield m.default.getFieldsByDomain(a.FieldDomains.Client),r=yield l.default.find({sourceId:[""+e],sourceName:[""+s.Models.CLIENTS_TABLE_NAME]});return{id:t.id,carIds:t.carIds,fields:(0,u.getFieldsWithValues)(i,r,t.id)}}))}completeDeal(e,t){return r(this,void 0,void 0,(function*(){const[i,r]=yield Promise.all([m.default.getFieldsByDomain(a.FieldDomains.Client),m.default.getFieldsByDomain(a.FieldDomains.Car)]),n=i.find(e=>e.name===o.FieldNames.Client.dealStatus),d=r.find(e=>e.name===o.FieldNames.Car.status),[u,c]=yield Promise.all([l.default.findOne({fieldId:[""+n.id],sourceId:[""+e],sourceName:[""+s.Models.CLIENTS_TABLE_NAME]}),l.default.findOne({fieldId:[""+d.id],sourceId:[""+t],sourceName:[""+s.Models.CARS_TABLE_NAME]})]),p=n.variants.split(",").findIndex(e=>e===o.FieldNames.DealStatus.Sold),y=d.variants.split(",").findIndex(e=>e===o.FieldNames.CarStatus.customerService_Sold),h=`${o.FieldNames.Client.dealStatus}-${-1!==p?p:0}`,v=`${o.FieldNames.Car.status}-${-1!==y?y:0}`;return yield Promise.all([f.default.updateFieldChain(u.id,{value:h}),f.default.updateFieldChain(c.id,{value:v})])}))}}},function(e,t,i){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=i(4),a=r(i(57)),o=(0,n.Router)();o.route("/").get(a.default.getAllRoles).post(a.default.createRole),o.route("/:roleId").get(a.default.getRole).delete(a.default.deleteRole).put(a.default.updateRole),t.default=o},function(e,t,i){"use strict";var r=this&&this.__awaiter||function(e,t,i,r){return new(i||(i=Promise))((function(n,a){function o(e){try{d(r.next(e))}catch(e){a(e)}}function s(e){try{d(r.throw(e))}catch(e){a(e)}}function d(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,s)}d((r=r.apply(e,t||[])).next())}))},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};const a=i(3),o=i(1),s=n(i(58));e.exports=new class{getAllRoles(e,t,i){return r(this,void 0,void 0,(function*(){try{const i=(0,a.validationResult)(e);if(!i.isEmpty())throw o.ApiError.BadRequest("Ошибка при валидации",i.array());const r=yield s.default.getAll();return t.json(r)}catch(e){i(e)}}))}createRole(e,t,i){return r(this,void 0,void 0,(function*(){try{const i=(0,a.validationResult)(e);if(!i.isEmpty())throw o.ApiError.BadRequest("Ошибка при валидации",i.array());const r=e.body,n=yield s.default.create(r);return t.json(n)}catch(e){i(e)}}))}getRole(e,t,i){return r(this,void 0,void 0,(function*(){try{const i=(0,a.validationResult)(e);if(!i.isEmpty())throw o.ApiError.BadRequest("Ошибка при валидации",i.array());const r=+e.params.roleId,n=yield s.default.get(r);return t.json(n)}catch(e){i(e)}}))}deleteRole(e,t,i){return r(this,void 0,void 0,(function*(){try{const i=(0,a.validationResult)(e);if(!i.isEmpty())throw o.ApiError.BadRequest("Ошибка при валидации",i.array());const r=+e.params.roleId,n=yield s.default.delete(r);return t.json(n)}catch(e){i(e)}}))}updateRole(e,t,i){return r(this,void 0,void 0,(function*(){try{const i=(0,a.validationResult)(e);if(!i.isEmpty())throw o.ApiError.BadRequest("Ошибка при валидации",i.array());const r=+e.params.roleId,n=e.body,d=yield s.default.update(r,n);return t.json(d)}catch(e){i(e)}}))}}},function(e,t,i){"use strict";var r=this&&this.__awaiter||function(e,t,i,r){return new(i||(i=Promise))((function(n,a){function o(e){try{d(r.next(e))}catch(e){a(e)}}function s(e){try{d(r.throw(e))}catch(e){a(e)}}function d(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,s)}d((r=r.apply(e,t||[])).next())}))},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};const a=i(0),o=n(i(15)),s=n(i(21));e.exports=new class{getAll(){return r(this,void 0,void 0,(function*(){const[e,t]=yield Promise.all([o.default.getAll(),s.default.find({sourceName:[""+a.Models.ROLES_TABLE_NAME]})]);return e.map(e=>({id:e.id,systemName:e.systemName,accesses:t.filter(t=>t.sourceId===e.id&&t.sourceName===""+a.Models.ROLES_TABLE_NAME)}))}))}get(e){return r(this,void 0,void 0,(function*(){const[t,i]=yield Promise.all([o.default.findById(e),s.default.find({sourceName:[""+a.Models.ROLES_TABLE_NAME]})]);return{id:t.id,systemName:t.systemName,accesses:i.filter(e=>e.sourceId===t.id&&e.sourceName===""+a.Models.ROLES_TABLE_NAME)}}))}create(e){return r(this,void 0,void 0,(function*(){const t=yield o.default.create({systemName:e.systemName});return yield Promise.all((e.accesses||[]).map(e=>s.default.create({sourceId:t.id,fieldId:e.fieldId,access:e.access,sourceName:a.Models.ROLES_TABLE_NAME}))),t}))}update(e,t){return r(this,void 0,void 0,(function*(){const i=yield o.default.updateById(e,{systemName:t.systemName}),r=t.accesses.length>0?yield s.default.find({fieldId:t.accesses.map(e=>""+e.fieldId),sourceId:[e].map(e=>""+e),sourceName:[a.Models.ROLES_TABLE_NAME]}):[],n=t.accesses.filter(e=>r.find(t=>t.fieldId===e.fieldId));return yield Promise.all((r||[]).map(t=>s.default.update({access:t.access},{fieldId:[t.fieldId].map(e=>""+e),sourceId:[e].map(e=>""+e),sourceName:[a.Models.ROLES_TABLE_NAME]}))),yield Promise.all((n||[]).map(t=>s.default.create({sourceId:e,fieldId:t.fieldId,access:t.access,sourceName:a.Models.ROLES_TABLE_NAME}))),i}))}delete(e){return r(this,void 0,void 0,(function*(){const t=yield s.default.find({sourceId:[e].map(e=>""+e),sourceName:[a.Models.ROLES_TABLE_NAME]});yield Promise.all(t.map(e=>s.default.deleteById(e.id)));return yield o.default.deleteById(e)}))}}},function(e,t,i){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=i(4),a=i(3),o=r(i(60)),s=i(61),d=i(10),l=(0,n.Router)();l.route(`/${d.Constants.API.CRUD}/`).get(s.authMiddleware,o.default.getAll).post(s.authMiddleware,(0,a.body)("email").isEmail(),(0,a.body)("password").isLength({min:3,max:32}),o.default.create),l.route(`/${d.Constants.API.CRUD}/:userId`).get(s.authMiddleware,o.default.get).delete(s.authMiddleware,o.default.delete).put(s.authMiddleware,o.default.update),t.default=l},function(e,t,i){"use strict";var r=this&&this.__awaiter||function(e,t,i,r){return new(i||(i=Promise))((function(n,a){function o(e){try{d(r.next(e))}catch(e){a(e)}}function s(e){try{d(r.throw(e))}catch(e){a(e)}}function d(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,s)}d((r=r.apply(e,t||[])).next())}))},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};const a=i(3),o=i(1),s=n(i(22));e.exports=new class{getAll(e,t,i){return r(this,void 0,void 0,(function*(){try{const r=(0,a.validationResult)(e);if(!r.isEmpty())return i(o.ApiError.BadRequest("Ошибка при валидации",r.array()));const n=yield s.default.getAll();return t.json(n)}catch(e){i(e)}}))}get(e,t,i){return r(this,void 0,void 0,(function*(){try{const r=(0,a.validationResult)(e);if(!r.isEmpty())return i(o.ApiError.BadRequest("Ошибка при валидации",r.array()));const n=+e.params.userId,d=yield s.default.get(n);return t.json(d)}catch(e){i(e)}}))}create(e,t,i){return r(this,void 0,void 0,(function*(){try{const r=(0,a.validationResult)(e);if(!r.isEmpty())return i(o.ApiError.BadRequest("Ошибка при валидации",r.array()));const n=e.body,d=yield s.default.create(n);return t.json(d)}catch(e){i(e)}}))}update(e,t,i){return r(this,void 0,void 0,(function*(){try{const r=(0,a.validationResult)(e);if(!r.isEmpty())return i(o.ApiError.BadRequest("Ошибка при валидации",r.array()));const n=+e.params.userId,d=e.body,l=yield s.default.update(n,d);return t.json(l)}catch(e){i(e)}}))}delete(e,t,i){return r(this,void 0,void 0,(function*(){try{const r=(0,a.validationResult)(e);if(!r.isEmpty())return i(o.ApiError.BadRequest("Ошибка при валидации",r.array()));const n=+e.params.userId,d=yield s.default.delete(n);return t.json(d)}catch(e){i(e)}}))}}},function(e,t,i){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.authMiddleware=void 0;const n=i(1),a=r(i(26));t.authMiddleware=function(e,t,i){try{const t=e.headers.authorization;if(!t)return i(n.ApiError.UnauthorizedError());const r=t.split(" ")[1];if(!r)return i(n.ApiError.UnauthorizedError());if(!a.default.validateAccessToken(r))return i(n.ApiError.UnauthorizedError());i()}catch(e){return i(n.ApiError.UnauthorizedError())}}},function(e,t){e.exports=require("jsonwebtoken")},function(e,t,i){"use strict";const r=i(0),n=i(2);class a extends n.BaseRepository{constructor(){super(r.Models.USER_TOKENS_TABLE_NAME)}}e.exports=new a},function(e,t,i){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=i(4),a=r(i(65)),o=i(3),s=(0,n.Router)();s.route("/registration").post((0,o.body)("email").isEmail(),(0,o.body)("password").isLength({min:3,max:32}),(0,o.body)("password").matches(/^(?=.*\d)(?=.*[a-z])(?=.*[A-Z])(?!.*\s).*$/),a.default.registration),s.route("/login").post(a.default.login),s.route("/logout").post(a.default.logout),s.route("/activate/:link").get(a.default.activate),s.route("/refresh").get(a.default.refresh),t.default=s},function(e,t,i){"use strict";var r=this&&this.__awaiter||function(e,t,i,r){return new(i||(i=Promise))((function(n,a){function o(e){try{d(r.next(e))}catch(e){a(e)}}function s(e){try{d(r.throw(e))}catch(e){a(e)}}function d(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,s)}d((r=r.apply(e,t||[])).next())}))};const n=(this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}})(i(66)),a=i(3),o=i(1);e.exports=new class{registration(e,t,i){return r(this,void 0,void 0,(function*(){try{const r=(0,a.validationResult)(e);if(!r.isEmpty())return i(o.ApiError.BadRequest("Ошибка при валидации",r.array()));const{email:s,password:d}=e.body,l=yield n.default.registration(s,d);return t.cookie("refreshToken",l.refreshToken,{maxAge:2592e6,httpOnly:!0}),t.json(l)}catch(e){i(e)}}))}login(e,t,i){return r(this,void 0,void 0,(function*(){try{const{email:i,password:r}=e.body,a=yield n.default.login(i,r);return t.cookie("refreshToken",a.refreshToken,{maxAge:2592e6,httpOnly:!0}),t.json(a)}catch(e){i(e)}}))}logout(e,t,i){return r(this,void 0,void 0,(function*(){try{const{refreshToken:i}=e.cookies;yield n.default.logout(i);return t.clearCookie("refreshToken"),t.json(!0)}catch(e){i(e)}}))}activate(e,t,i){return r(this,void 0,void 0,(function*(){try{const i=e.params.link;return yield n.default.activate(i),t.redirect(process.env.CLIENT_URL)}catch(e){i(e)}}))}refresh(e,t,i){return r(this,void 0,void 0,(function*(){try{const{refreshToken:i}=e.cookies,r=yield n.default.refresh(i);return t.cookie("refreshToken",r.refreshToken,{maxAge:2592e6,httpOnly:!0}),t.json(r)}catch(e){i(e)}}))}}},function(e,t,i){"use strict";var r=this&&this.__awaiter||function(e,t,i,r){return new(i||(i=Promise))((function(n,a){function o(e){try{d(r.next(e))}catch(e){a(e)}}function s(e){try{d(r.throw(e))}catch(e){a(e)}}function d(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,s)}d((r=r.apply(e,t||[])).next())}))},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};const a=n(i(23)),o=i(24),s=n(i(25)),d=n(i(26)),l=i(1),u=n(i(14)),c=i(67),f=i(68),m=n(i(15));e.exports=new class{registration(e,t){var i;return r(this,void 0,void 0,(function*(){if(yield u.default.findOne({email:[e]}))throw l.ApiError.BadRequest(`User with ${e} exists`);const r=yield a.default.hash(t,3),n=(0,o.v4)(),p=yield m.default.getAll(),y=yield u.default.create({email:e,isActivated:!1,password:r,activationLink:n,roleLevel:c.ServerRole.System.None}),h=Object.assign(Object.assign({},y),{customRoleName:(null===(i=p.find(e=>e.id+1e3===y.roleLevel))||void 0===i?void 0:i.systemName)||""});yield s.default.sendActivationMail(e,process.env.API_URL+"/activate/"+n);const v=new f.ServerAuth.Payload(h),g=d.default.generateTokens(Object.assign({},v));return yield d.default.saveToken(v.id,g.refreshToken),Object.assign(Object.assign({},g),{user:v})}))}activate(e){return r(this,void 0,void 0,(function*(){const t=yield u.default.findOne({activationLink:[e]});if(!t)throw l.ApiError.BadRequest("User not exists");t.isActivated=!0,u.default.updateById(t.id,t)}))}login(e,t){var i;return r(this,void 0,void 0,(function*(){const r=yield u.default.findOne({email:[e]});if(!r)throw l.ApiError.BadRequest("Пользователь с таким email не найден");if(!(yield a.default.compare(t,r.password)))throw l.ApiError.BadRequest("Неверный пароль");const n=yield m.default.getAll(),o=Object.assign(Object.assign({},r),{customRoleName:(null===(i=n.find(e=>e.id+1e3===r.roleLevel))||void 0===i?void 0:i.systemName)||""}),s=new f.ServerAuth.Payload(o),c=d.default.generateTokens(Object.assign({},s));return yield d.default.saveToken(s.id,c.refreshToken),Object.assign(Object.assign({},c),{user:s})}))}logout(e){return r(this,void 0,void 0,(function*(){return yield d.default.removeToken(e)}))}refresh(e){var t;return r(this,void 0,void 0,(function*(){if(!e)throw l.ApiError.UnauthorizedError();const i=d.default.validateRefreshToken(e),r=yield d.default.findToken(e);if(!i||!r)throw l.ApiError.UnauthorizedError();const n=yield u.default.findById(i.id),a=yield m.default.getAll(),o=new f.ServerAuth.Payload(Object.assign(Object.assign({},n),{customRoleName:(null===(t=a.find(e=>e.id+1e3===n.roleLevel))||void 0===t?void 0:t.systemName)||""})),s=d.default.generateTokens(Object.assign({},o));return yield d.default.saveToken(o.id,s.refreshToken),Object.assign(Object.assign({},s),{user:o})}))}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ServerRole=void 0,function(e){let t,i;!function(e){e[e.None=0]="None",e[e.Admin=900]="Admin",e[e.SuperAdmin=1e3]="SuperAdmin"}(t=e.System||(e.System={})),function(e){e.contactCenter="contactCenter",e.contactCenterChief="contactCenterChief",e.carShooting="carShooting",e.carShootingChief="carShootingChief",e.customerService="customerService",e.customerServiceChief="customerServiceChief",e.carSales="carSales",e.carSalesChief="carSalesChief"}(i=e.Custom||(e.Custom={}))}(t.ServerRole||(t.ServerRole={}))},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ServerAuth=void 0,function(e){e.Payload=class{constructor(e){this.id=e.id,this.email=e.email,this.isActivated=e.isActivated,this.roleLevel=e.roleLevel,this.customRoleName=e.customRoleName}}}(t.ServerAuth||(t.ServerAuth={}))},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.errorMiddleware=void 0;const r=i(1);t.errorMiddleware=function(e,t,i,n){return e instanceof r.ApiError?i.status(e.status).json({message:e.message,errors:e.errors}):(console.error(e),i.status(500).json({message:"Непридвиденная ошибка"}))}},function(e,t){e.exports=require("express-fileupload")}]);